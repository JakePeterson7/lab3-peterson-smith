import java.io.FileWriter;
import java.io.IOException;

import static java.util.Arrays.copyOfRange;

class CBCMode {
    private static int[] XORtext = new int[35]; //Used for storing result of encrypt for future blocks

    static int[] cipher(int[] key, String text, int crypt, int[] IV) {
        int[] plainBin;
        if(crypt == 0) {
            plainBin = BlockCipher.stringToBinaryArray(text);
        }else{
            plainBin = BlockCipher.binaryStringToBinaryArray(text); //Turns a binary string to a binary array
        }
        int[] cipherText = new int[plainBin.length]; //Initialize int array for storing result
        if (crypt == 1) { //Look at which time of cryption that is being asked, then do the specified one
            decrypt(key, plainBin, IV, cipherText); //Decrypt cipherText
        } else {
            encrypt(key, plainBin, IV, cipherText); //Encrypt plaintext
        }
        return cipherText; //Return resulting text
    }

    public static void encrypt(int[] keyBin, int[] plainBin, int[] IV, int[] cipherText) {
        int[] temp; //Holds encrypted block
        int[] tempBin; //Holds plaintext to be encrypted
        int l = plainBin.length; //Readability
        initialEncryption(keyBin, plainBin, IV, cipherText); //Initial run of encryption
            for (int i = 1; i < l / 35; i++) { //For each block after the first
                tempBin = copyOfRange(plainBin, (i * 35), ((i * 35) + 35)); //Copy plaintext block into tempBin
                int[] newInput = BlockCipher.addBinaryArrays(tempBin, XORtext); //XOR plaintext and saved XORtext
                temp = BlockCipher.Encrypt(newInput, keyBin); //Encrypt result of XOR with key
                System.arraycopy(temp, 0, cipherText, (i * 35), 35); //Copy result to resulting ciphertext
                System.arraycopy(temp, 0, XORtext, 0, 35); //Overwrite XORtext with result for further encryption
            }
//            if (l % 35 != 0) { //Handles overflow
//                tempBin = copyOfRange(plainBin, (l - l % 35), l);
//                int[] newInput = BlockCipher.addBinaryArrays(tempBin, XORtext);
//                temp = BlockCipher.Encrypt(newInput, keyBin);
//                System.arraycopy(temp, 0, cipherText, (l - l % 35), temp.length);
//            }
    }

    public static void initialEncryption(int[] keyBin, int[] plainBin, int[] IV, int[] cipherText) {
        int[] temp; //Holds encrypted block
        int[] tempBin; //Holds plaintext to be encrypted
        tempBin = copyOfRange(plainBin, 0,  35); //Copy plaintext block into tempBin
        int[] newInput = BlockCipher.addBinaryArrays(tempBin, IV); //XOR plaintext and IV
        temp = BlockCipher.Encrypt(newInput, keyBin); //Encrypt result of XOR with key
        System.arraycopy(temp, 0, XORtext, 0, 35); //Copy result of encrypt for future XORs
        System.arraycopy(temp, 0, cipherText, 0, 35); //Copy result to resulting ciphertext
    }

    public static void decrypt(int[] keyBin, int[] plainBin, int[] IV, int[] cipherText) {
        int[] temp; //Holds encrypted block
        int[] tempBin; //Holds plaintext to be encrypted
        int l = plainBin.length; //Readability
        initialDecryption(keyBin, plainBin, IV, cipherText); //Initial run of decryption
            for (int i = 1; i < l / 35; i++) { //For each block after the first
//                System.out.println("i: " + i);
                tempBin = copyOfRange(plainBin, (i * 35), ((i * 35) + 35)); // Copy ciphertext block into tempBin
                temp = BlockCipher.Decrypt(tempBin, keyBin); //Decrypt ciphertext with key
                int[] newInput = BlockCipher.addBinaryArrays(temp, XORtext); //XOR result of decrption with last block ciphertext
                System.arraycopy(newInput, 0, cipherText, (i * 35), 35); //Copy result of decrypt to resulting plaintext
                System.arraycopy(tempBin, 0, XORtext, 0, 35); //Copy ciphertext from this block for next block
            }
//            if (l % 35 != 0) { //Handles overflow
//                tempBin = copyOfRange(plainBin, (l - l % 35), l);
//                temp = BlockCipher.Decrypt(tempBin, keyBin);
//                int[] newInput = BlockCipher.addBinaryArrays(temp, XORtext);
//                System.arraycopy(newInput, 0, cipherText, (l - l % 35), temp.length);
//            }
    }

    public static void initialDecryption(int[] keyBin, int[] plainBin, int[] IV, int[] cipherText) {
        int[] temp; //Holds encrypted block
        int[] tempBin; //Holds plaintext to be encrypted
        System.arraycopy(plainBin, 0, XORtext, 0, 35); //Copy ciphertext block for next block
        tempBin = copyOfRange(plainBin, 0,  35); //Copy ciphertext block into tempBin
        int[] newInput = BlockCipher.Decrypt(tempBin, keyBin); //Decrypt result of XOR with key
        temp = BlockCipher.addBinaryArrays(newInput, IV); //XOR ciphertext with IV
        System.arraycopy(temp, 0, cipherText, 0, 35); //Copy result of decrypt to resulting plaintext
    }

    public static void main(String[] args) throws IOException { //Test encrypt and decrypt
//        String text = "001001000000010100010100101010000011011111101011000010100010111001111111001100010110100011100001001010100010000010001100001110001110010111010111011001110000101111001101010011000010101110101100010101101010100011110010000110110001110000000011100111000011110010110001111001111111101100001111001000010011010001011111010001111110011111100011100011101110101011100111010000100100000100010001101101000111011110110000111110010011001101101000010110011111011101111100110100000101001110100001000101000001110011110101101000101011100111111100100000100110111011001000110101011001100011010001100010011101101111100001011100011000000010101011111110011110110110100110111100011010010001100010110111100100010000111000010001100010101000010010110011000010100001101010000011110011000010101001011100110001110011010110001110100000100100111010101010001100010111011100110110110011101100000010111101011000100001111110111110100100010001100001110010111001100000100110001110110011101111000101110110010110101110010110010000100110110010101001100000011100110010100100110100110111101101010001011001111111111101010100110010111011010100100110011010101001011000100100000001000010001001001100110100111011101100001111001001011011110110101101101000111111001100111101010110100011101101011110011111101011111010001011111111110100011110010100000011110001110110001010101100110101111011011010101110001001001000100110101011111010110101111101111111111011000001101101000111100001010101110101001100111101001010100000001000101010101110011011100100110001001100110110000001101011001000111011001110100111010100000001000101100011011100001100111110110100001110110001111110111011011111100001101101010110000100101010010100001100010111110010000111011011111011110101011100110100001101100101011111011000110111011010111101010101000100111101001101011000111010111110100110101001010010001010100101111111000110010101111111001001110101110001100100101001111000011100100100000000101011111001010101001010110111001001000101000011100001101101011000100001001010010010010100001110111011101100110101010011111000101101110011110111000010100111011101010101111011100110011100001100001000110000000100011111010110001101100111010111011000110000000110110001110011000011000101100011101111011101001001011000000101010111100100100000101101000000111101101010010010111111001101110111011111110110000000010001111010101101000101001101101010101011011000011000110110001101001011110110100010011100001010001111101100101000000100100001010101010010101000100100110000000110111010110010001001111001100111010101010011010001111100101011111001001001101011001111000010001000010111110111100101100110001001010110111110001110000001100010110111111101011000001100111011001011000001101100111010001100000100100101000001111001010111101111100100111111101001110101100110000011010010100011010001000100101100011111100011010111000000101011001100000100010100000110011011011101011100010110011110111110110000001011101011110111110000110010001110110010110110011001111010110101001111011010011101111100000010010111100110001101010010101000010000100000010010011000101110000111110110010000100010011000001010111010010001110010100111110001100100011000101000110001111001100101110100000000010111011010110111100000110011011101111110110001001010001011010001101100110011111110011001101100011000101100100000111011010000010010011111100100011001100001000011110010001100001011110001000110101111111000111101010111110111100010011001010111010000101111010110011111010101100000001010001101000111100000001111111101110100111011110101111111101110100010110011111001010100100000010101110111011100010101001110110101111000001011101110011111110100010000110110011110010101010100011010011001010001011111010001101111000001100101111101100010111000011101000011010000011000110110111100101000101110001111111101111100000001110011110111010111111001100000000100100111000100011011010011101110001000110110001100010101001111110111110000001110011011101010100011110100000011110100011111111101001000101110111100000011000101101100001100100000110100011000101101110001101111101010110001111001100001101001000000111111100001101111001000010000100100010101111001111111001000110101100000111011000001001110110001110100001011100110111100100101100111000011110111100010110000101101111111111001100101001100110101001000100000110100010100110010110000100110110001111000011111101011001010110010011011110010011001100101111111011111001000001101101010110111011101110100101111100001001001010010101010001011111010100100101000101111100000110110010000100001000101110001101100010001001000011011011010011100110101010001111001010000011000111110011010110001101111011101111000110100010001011110110000100100100001011010100010011110101010110110010111001101010111011101000011000001010111100011001111010010100011101011010110010000000101011110011110011101011100010001100011000001101010100001000101000011000010010100100011010111000110101110111101101011101001101100111000100110111101100011010111111010111001110011001010111011101000011010010000101101111011111001010101001011101001101100001011010001001011111100101011001101101111101110101011011010000100100100011111011111010111011000111101010111001110010100010101100111010100010000100001111010111001101100100000101100011111111001010111010110110110010011001111111001100011010010010011001001001010000010101111101011011001010010100000011000000100011111101100101001001101100000010111111001110111011001011000100000101010101011110000010001110101000001000111001111100111001010110010101010001010101101011010100001010001010111101101001110000000001101101101111100010100010101010011100100000101001111011001010001001110111110101101101011100011111100100111100000110100000101011110101110100111010111101111001010110010001001110001101001001100000100111001110100111001100100111100001101101101000000001110100111111011011010011111110010011100000111011011100011001111111010010000101100110011010100000010110110101011010000101001111001100011110011010111011000110101101111011110000110000110101100010010000000110110001100010111111101011011010101100111100100000110001110000011011110101111101110110000000101001011101111000100010101110110000110011100011100100001101001111010001110001010001001111000100111110100001100100100101011110011111010100001101001111100010001001011111100000110101110010010100000010001000100010100010111110001100110101011100011100100010011001010000100010111000101111101000101101000011111111011011011110011110111010011101010001101101000100010110001100111000001000101111001111011100100101110001110010110001111110100100001110111011101100111100100100100101010000100101111000100000110111000001100000110110000011111110100110100000010001100011000010001000111101000110011010010111111001";
        String text = "When Mr. Bilbo Baggins of Bag End announced that he would shortly be celebrating his eleventy-first birthday with a party of special magnificence, there was much talk and excitement in Hobbiton. Bilbo was very rich and very peculiar, and had been the wonder of the Shire for sixty years, ever since his remarkable disappearance and unexpected return. The riches he had brought back from his travels had now become a local legend, and it was popularly believed, whatever the old folk might say, that the Hill at Bag End was full of tunnels stuffed with treasure. And if that was not enough for fame, there was also his prolonged vigour to marvel at. Time wore on, but it seemed to have little effect on Mr. Baggins. At ninety he was much the same as at fifty. At ninety-nine they began to call him well-preserved, but unchanged would have been nearer the mark. There were some that shook their heads and thought this was too much of a good thing; it seemed unfair that anyone should possess (apparentl";
        int[] key = BlockCipher.stringToBinaryArray("pvvhd");
        int[] IV = BlockCipher.stringToBinaryArray("neifg");
        CBCMode CBC = new CBCMode();
        String result = BlockCipher.binaryArrayToBinaryString(CBC.cipher(key, text, 0, IV));
        System.out.println("Result: " + result);
//        String result2 = BlockCipher.binaryArrayConvertToASCII(CBC.cipher(key, txt, 1, IV));
//        System.out.println("Result: " + result2);
        FileWriter myWriter = new FileWriter("filename.txt");
        myWriter.write(result);
        myWriter.close();
        System.out.println("Wrote to file!");
        CBCtest();
    }

    //test for 1-bit error.
    public static void CBCtest(){
        // setup
        System.out.println("\n\n\n start CBC test---------------------------------------------------------");
        String text = "I am happy to join with you today in what will go down in history as the greatest demonstration";
        int[] key = new int[]{1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0,0,1,0,0,1,1,1,0,0,1,1};
        int[] IV = new int[]{0,1,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0};

        //encrpyt
        String result = BlockCipher.binaryArrayConvertToASCII(CBCMode.cipher(key, text, 0, IV));
        //System.out.println(result);
        int[] encrypted = BlockCipher.stringToBinaryArray(result);

        BlockCipher.printIntArray(encrypted);
        System.out.println();
        // 1-bit error: change bit 10 from original.
        int[] original = BlockCipher.stringToBinaryArray(text);
        if(original[10] == 1){
            original[10] = 0;
        } else{
            original[10] = 1;
        }
        String augmentedText = BlockCipher.binaryArrayConvertToASCII(original);

        String newResult = BlockCipher.binaryArrayConvertToASCII(CBCMode.cipher(key, augmentedText, 0, IV));
        int[] encrypted2 = BlockCipher.stringToBinaryArray(newResult);
        BlockCipher.printIntArray(encrypted2);

    }
}
